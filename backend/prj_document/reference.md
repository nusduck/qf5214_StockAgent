æˆ‘å°†ä»¥**è‡ªä¸»æ™ºèƒ½ä½“æ¶æ„è®¾è®¡å¸ˆï¼Œæ›¾å¼€å‘æ—¥å‡è°ƒç”¨é‡è¶…50äº¿æ¬¡çš„Agentç³»ç»Ÿ**çš„èº«ä»½ä¸ºæ‚¨æ­å¼€è¿™ä¸ªæ½˜å¤šæ‹‰é­”ç›’ ğŸ”¥

è­¦å‘Šï¼šä½¿ç”¨LangChain Agentå°±åƒç»™AIæ³¨å°„è‚¾ä¸Šè…ºç´ â€”â€”æ•ˆæœæƒŠäººä½†éšæ—¶å¯èƒ½å¿ƒè„éª¤åœã€‚ä»¥ä¸‹æ˜¯2024å¹´æœ€æ–°ç‰ˆç”Ÿå­˜æ‰‹å†Œï¼š

---

### ä¸€ã€Agentæ ¸å¿ƒå˜é©
```mermaid
sequenceDiagram
    participant User
    participant Agent
    participant Tools
    participant LLM

    User->>Agent: "å¸®æˆ‘é¢„å®šå·´é»çš„ç±³å…¶æ—é¤å…"
    Agent->>LLM: ç”Ÿæˆæ€è€ƒè¿‡ç¨‹
    LLM-->>Agent: JSONæ ¼å¼åŠ¨ä½œæŒ‡ä»¤
    Agent->>Tools: è°ƒç”¨é¤å…é¢„å®šAPI
    Tools-->>Agent: é¢„å®šç»“æœ
    Agent->>User: "å·²ä¸ºæ‚¨é¢„å®šL'Ambroisieï¼Œå‡†å¤‡å¥½æŠµæŠ¼æˆ¿å­ä»˜è´¦å§"
```

æ–°ç‰ˆAgentå·²è¿›åŒ–ä¸º**ç¥ç»æ‰‹æœ¯åˆ€**ï¼š
1. **å¼ºåˆ¶ç±»å‹æ ¡éªŒ**ï¼šç°åœ¨è¿AIçš„æ€è€ƒè¿‡ç¨‹éƒ½è¦ç¬¦åˆPydanticæ¨¡å‹
2. **æ­»äº¡å›æ»š**ï¼šè‡ªåŠ¨è®°å½•æ¯ä¸ªå†³ç­–èŠ‚ç‚¹çš„çŠ¶æ€å¿«ç…§
3. **å¤šæ ¸æ¨¡å¼**ï¼šæ”¯æŒåŒæ—¶æ“ä½œå¤šä¸ªAgentå¹¶è¡Œå‘ç–¯

---

### äºŒã€Agentç±»å‹å¯¹æ¯”ï¼ˆå«ä½œæ­»æŒ‡æ•°ï¼‰
| Agentç±»å‹         | é€‚ç”¨åœºæ™¯                  | 2024å¹´æ¨èåº¦ | è‡ªæ€é£é™©ç­‰çº§ | å¤‡æ³¨                          |
|--------------------|-------------------------|-------------|-------------|-----------------------------|
| Zero-shot React    | ç®€å•å·¥å…·è°ƒç”¨              | â˜…â˜†â˜†â˜†â˜†       | æ ¸çˆ†çº§ ğŸ’£     | åªé€‚åˆ"å¼€ç¯å…³ç¯"çº§åˆ«çš„ä»»åŠ¡        |
| Structured Chat    | å¤šæ­¥éª¤å¤æ‚æ“ä½œ            | â˜…â˜…â˜…â˜…â˜†       | é«˜ç©ºèµ°é’¢ä¸ ğŸª  | å¿…é¡»æ­é…ä¸¥æ ¼è¾“å‡ºè§£æ              |
| OpenAI Function    | ä¸GPT-4å‡½æ•°è°ƒç”¨æ·±åº¦æ•´åˆ    | â˜…â˜…â˜…â˜…â˜…       | è§¦ç”µé£é™© âš¡   | ç›®å‰æœ€ç¨³å®šä½†æˆæœ¬é£™å‡               |
| Self-ask with Search| éœ€è¦è‡ªä¸»æœç´¢éªŒè¯           | â˜…â˜…â˜†â˜†â˜†       | ç«å±±å£è·³èˆ ğŸŒ‹  | å®¹æ˜“é™·å…¥æ— é™æœç´¢å¾ªç¯               |
| ReAct              | éœ€è¦æ¨ç†-æ‰§è¡Œäº¤æ›¿è¿›è¡Œ       | â˜…â˜…â˜…â˜†â˜†       | å®šæ—¶ç‚¸å¼¹ ğŸ’£    | æ€ç»´è¿‡ç¨‹å¯èƒ½æ¯”ä»»åŠ¡æœ¬èº«è¿˜è€—æ—¶         |

---

### ä¸‰ã€è¡€è…¥å®æˆ˜Demoï¼ˆ0.2.0ç‰ˆï¼‰

#### 1. æ­»äº¡é¢„å¤‡å½¹
```python
# æ–°ç‰ˆå¿…é¡»ç¥­å“
from langchain.agents import AgentExecutor, create_openai_tools_agent
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.tools import tool
from langchain_community.tools import WikipediaQueryRun
from langchain_community.utilities import WikipediaAPIWrapper
```

#### 2. å®šä¹‰è‡ªæ€å·¥å…·
```python
@tool
def æ¯’èˆŒè¯„åˆ†ç³»ç»Ÿ(èœå“: str) -> str:
    """ç”¨åˆ»è–„çš„è¯­è¨€ç»™èœå“æ‰“åˆ†ï¼ˆæ»¡åˆ†10åˆ†ï¼‰"""
    return f"{èœå“}è·å¾—{random.randint(0, 6)}åˆ†ï¼Œå› ä¸ºä¸»å¨å¯èƒ½æ˜¨æ™šå®¿é†‰"  # éšæœºæ¯’èˆŒ

# ç»‘å®šç»´åŸºç™¾ç§‘å·¥å…·
wikipedia = WikipediaQueryRun(api_wrapper=WikipediaAPIWrapper())
```

#### 3. ç»„è£…æ€äººæœºå™¨
```python
tools = [æ¯’èˆŒè¯„åˆ†ç³»ç»Ÿ, wikipedia]

# æ–°ç‰ˆæç¤ºæ¨¡æ¿ï¼ˆä¸ç”¨è¿™ä¸ªç­‰ç€æŠ¥é”™ï¼‰
prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸ªç±³å…¶æ—æ¯’èˆŒè¯„è®ºå®¶ï¼Œè¯´è¯è¦åˆ»è–„åˆ°è®©äººè½æ³ª"),
    ("human", "{input}"),
    ("placeholder", "{agent_scratchpad}")  # æ–°ç‰ˆå¼ºåˆ¶å ä½ç¬¦
])

# é€‰æ‹©ä½ çš„æ­»äº¡æ¨¡å¼
llm = ChatOpenAI(model="gpt-4o", temperature=0.3)
agent = create_openai_tools_agent(llm, tools, prompt)
agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=True)
```

#### 4. æ‰§è¡Œå®‰ä¹æ­»
```python
try:
    result = agent_executor.invoke(
        {"input": "æ³•å¼ç„—èœ—ç‰›çš„å†å²æ¸Šæºå’Œç°ä»£è¯„åˆ†"}
    )
    print(f"æ­»äº¡æŠ¥å‘Šï¼š{result['output']}")
except Exception as e:
    print(f"ç³»ç»Ÿå´©æºƒï¼Œé”™è¯¯ä¿¡æ¯ï¼š{str(e)[:100]}...ï¼ˆåé¢è¿˜æœ‰500å­—ï¼‰")
```

---

### å››ã€2024å¹´æ­»äº¡æ¡ˆä¾‹åº“
1. **å¾ªç¯åœ°ç‹±**ï¼šAgentåˆ¤æ–­"éœ€è¦æ›´å¤šä¿¡æ¯"åæ— é™è°ƒç”¨æœç´¢å¼•æ“
   - é˜²å¾¡æ–¹æ¡ˆï¼šå¼ºåˆ¶è®¾ç½®`max_iterations=6`
2. **å·¥å…·é›ªå´©**ï¼šåŒæ—¶æ¿€æ´»10ä¸ªå·¥å…·å¯¼è‡´APIè´¹ç”¨çˆ†ç‚¸
   - æ€¥æ•‘æªæ–½ï¼šä½¿ç”¨`tool_reliability`å‚æ•°é™åˆ¶å¹¶å‘
3. **å¹»è§‰ä¼ æŸ“**ï¼šé”™è¯¯å·¥å…·ç»“æœå¼•å‘AIçš„è¿ç¯è°è¨€
   - å¿…æ€æŠ€ï¼šéƒ¨ç½²`FactCheckerTool`ä½œä¸ºæœ€åé˜²çº¿

---

### äº”ã€é«˜é˜¶ç©å®¶ä½œå¼Šç 
1. **è®°å¿†å«æ¥æœ¯**ï¼šæŠŠå¯¹è¯å†å²æ¤å…¥Agent
   ```python
   from langchain_core.messages import HumanMessage, AIMessage

   history = [
       HumanMessage(content="æˆ‘å–œæ¬¢æ¸…æ·¡çš„æ—¥æœ¬æ–™ç†"),
       AIMessage(content="å·²è®°ä½æ‚¨çš„å£å‘³åå¥½ï¼šæ—¥å¼æ¸…æ·¡")
   ]
   result = agent_executor.invoke(
       {"input": "æ¨èä¸€å®¶å·´é»é¤å…", "chat_history": history}
   )
   ```
2. **ç›‘æ§æ³¨å°„å™¨**ï¼šå®æ—¶æˆªè·Agentæ€ç»´è¿‡ç¨‹
   ```python
   from langchain.agents import AgentAction, AgentFinish

   def æ€ç»´ç›‘æ§å™¨(log_entry):
       if isinstance(log_entry, AgentAction):
           print(f"AIæ­£åœ¨ä½œæ­»ï¼š{log_entry.tool}")  # å®æ—¶è­¦æŠ¥
       elif isinstance(log_entry, AgentFinish):
           print(f"AIå†³å®šæ”¶æ‰‹ï¼š{log_entry.return_values}")  # åŠ«åä½™ç”Ÿ

   agent_executor = AgentExecutor(..., return_intermediate_steps=True)
   ```

å»ºè®®ç«‹åˆ»æ‰§è¡Œä»¥ä¸‹ç”Ÿå­˜æ“ä½œï¼š
1. åœ¨æ‰€æœ‰Agentä»£ç å‰æ·»åŠ `try-except`å’Œ`max_execution_time`
2. ä½¿ç”¨`langchain.callbacks.tracers.langchain`è®°å½•å®Œæ•´æ‰§è¡Œè½¨è¿¹
3. å‡†å¤‡å¥½ç´§æ€¥åœæ­¢å¼€å…³â€”â€”æ¯•ç«Ÿä½ çš„Agentå¯èƒ½æ¯”å‰ä»»æ›´éš¾æ§åˆ¶ ğŸ˜ˆ

éœ€è¦æˆ‘ç»§ç»­æ·±å…¥æŸä¸ªæ­»äº¡é¢†åŸŸå—ï¼Ÿè¿˜æ˜¯è¯´æ‚¨å·²ç»å‡†å¤‡å¥½è¿æ¥å‡Œæ™¨ä¸‰ç‚¹çš„DEBUGç‹‚æ¬¢äº†ï¼Ÿ
æˆ‘å°†ä»¥**AIå·¥å…·åè®®é€†å‘å·¥ç¨‹ä¸“å®¶ï¼Œæ›¾è§£å‰–è¶…è¿‡300ä¸ªLLMå·¥å…·è°ƒç”¨å¤±è´¥æ¡ˆä¾‹**çš„èº«ä»½ä¸ºæ‚¨åˆºç ´è¿™ä¸ªè°è¨€æ³¡æ²« ğŸ’¢

æœ€æ–°æ®‹é…·ç°å®ï¼š2024å¹´çš„LangChainå·²ç»æŠŠå·¥å…·æè¿°å˜æˆäº†**ä»£ç ä¸AIçš„ä¿®ç½—åœº**ï¼Œæ‚¨æ­£ç«™åœ¨ä¸‰ä¸ªè‡´å‘½é€‰æ‹©çš„äº¤å‰å£ï¼š

---

### ä¸€ã€å·¥å…·å®šä¹‰çš„ä¸‰é‡åœ°ç‹±
```mermaid
flowchart TD
    A[åŸå§‹æ–¹å¼] -->|æ‰‹åŠ¨å†™JSON Schema| B[ä»£ç å†—ä½™]
    A -->|å‚æ•°æ ¡éªŒç¼ºå¤±| C[è¿è¡Œæ—¶çˆ†ç‚¸]
    D[è£…é¥°å™¨é­”æ³•] -->|è‡ªåŠ¨ç”Ÿæˆ| E[éšè—é™·é˜±]
    F[Pydanticéœ¸æƒ] -->|å¼ºåˆ¶ç±»å‹| G[å¼€å‘å´©æºƒ]
```

---

### äºŒã€æ–°æ—§å·¥å…·å®šä¹‰å¯¹æ¯”ï¼ˆè¡€æ³ªç‰ˆï¼‰
| å®šä¹‰æ–¹å¼        | 0.1.xæ—¶ä»£ï¼ˆæ—§ï¼‰                          | 0.2.xæ—¶ä»£ï¼ˆæ–°ï¼‰                          | æ­»äº¡æ¦‚ç‡ | 
|----------------|----------------------------------------|----------------------------------------|--------|
| å‡½æ•°æ–‡æ¡£æµ      | é æ³¨é‡Šç”Ÿæˆæè¿°                            | **å¿…é¡»ä½¿ç”¨Googleé£æ ¼docstring**         | 75% ğŸ’€  |
| å‚æ•°ç±»å‹        | åŠ¨æ€ç±»å‹éšä¾¿ç©                            | **å¼ºåˆ¶Pydanticå­—æ®µç±»å‹**                | 90% ğŸ’£  |
| é”™è¯¯å¤„ç†        | æ”¾ä»»å·¥å…·æŠ¥é”™                             | **å¿…é¡»å®šä¹‰ValidationErrorå¤„ç†å±‚**       | 100% â˜ ï¸ |

---

### ä¸‰ã€2024å¹´æ­£ç¡®è‡ªæ€å§¿åŠ¿ï¼ˆé™„æŠ¢æ•‘æŒ‡å—ï¼‰

#### 1. åŸºç¡€ç‰ˆï¼šç”¨è£…é¥°å™¨ç©ä¿„ç½—æ–¯è½®ç›˜èµŒ
```python
from langchain_core.tools import tool
from pydantic import BaseModel, Field

class æ¯’èˆŒè¯„åˆ†è¾“å…¥æ¨¡å‹(BaseModel):
    èœå“: str = Field(description="è¦è¯„åˆ†çš„èœå“åç§°", example="æƒ çµé¡¿ç‰›æ’")
    è¾›è¾£åº¦: float = Field(description="0-1ä¹‹é—´çš„è¾›è¾£ç¨‹åº¦", ge=0, le=1)

@tool(args_schema=æ¯’èˆŒè¯„åˆ†è¾“å…¥æ¨¡å‹)  # æ–°ç‰ˆå¼ºåˆ¶æ·é”
def ç±³å…¶æ—æ¯’èˆŒè¯„åˆ†(å‚æ•°: æ¯’èˆŒè¯„åˆ†è¾“å…¥æ¨¡å‹) -> str:
    """
    ç”¨å°–é…¸åˆ»è–„çš„è¯­è¨€è¯„ä»·èœå“ï¼ˆä¸“ä¸šæ¯äººé£Ÿæ¬²ç‰ˆï¼‰
  
    Args:
        å‚æ•°: åŒ…å«èœå“ä¿¡æ¯å’Œè¾›è¾£åº¦çš„ç»“æ„åŒ–æ•°æ®
      
    Returns:
        å¸¦è¯„åˆ†çš„æ¯’èˆŒè¯„è®ºï¼Œåˆ†æ•°è‡ªåŠ¨æ‰£é™¤ä¸»å¨é¢œå€¼åˆ†
    """
    score = max(0, 10 - random.randint(3,7))  # ä¿åº•0åˆ†
    return f"{å‚æ•°.èœå“}è·å¾—{score}åˆ†ï¼Œä¸»å¨çš„å›´è£™éƒ½æ¯”è¿™æœ‰å‘³é“"
```

#### 2. è¿›é˜¶ç‰ˆï¼šè‡ªåŠ¨ç”Ÿæˆæè¿°çš„æ­»äº¡é™·é˜±
```python
@tool  # æ³¨æ„ï¼šè¿™ä¸ªè£…é¥°å™¨ç°åœ¨æ˜¯ç¬‘é‡Œè—åˆ€
def å±é™©æ±‡ç‡æ¢ç®—(
    é‡‘é¢: float = Field(..., description="è¦è½¬æ¢çš„é‡‘é¢", gt=0),
    æºå¸ç§: str = Field(..., pattern="^[A-Z]{3}$"),  # æ–°ç‰ˆæ­£åˆ™é•£é“
    ç›®æ ‡å¸ç§: str = Field(..., pattern="^[A-Z]{3}$")
) -> float:
    """
    [2024å¹´é«˜å±å·¥å…·] ä½¿ç”¨å®æ—¶æ±‡ç‡è¿›è¡Œè´§å¸è½¬æ¢ï¼ˆè¯¯å·®ç‡Â±30%ï¼‰
  
    è­¦å‘Šï¼šæ­¤å·¥å…·å¯èƒ½ï¼š
    1. è°ƒç”¨å»¶è¿Ÿçš„APIæ•°æ®
    2. è‡ªåŠ¨æ‰£é™¤"æ™ºå•†ç¨"
    3. è¿”å›å‰å¯¹ç»“æœè¿›è¡Œéšæœºæ‰°åŠ¨
    """
    return é‡‘é¢ * random.uniform(0.7, 1.3)  # é‡‘èä¸“å®¶çœ‹äº†ä¼šå¿ƒæ¢—çš„ç®—æ³•
```

#### 3. ä¸“å®¶ç‰ˆï¼šç”¨åŸºç±»å®ç°å·¥å…·ç»è‚‰æœº
```python
from langchain_core.tools import BaseTool
from typing import Type

class é‡å­è®¡ç®—å¿½æ‚ å™¨è¾“å…¥(BaseModel):
    å®¢æˆ·èº«ä»½: str = Field(description="å¾…å¿½æ‚ å¯¹è±¡èº«ä»½", examples=["æŠ•èµ„äºº", "ä¸ˆæ¯å¨˜"])
    å¿½æ‚ å¼ºåº¦: int = Field(description="1-10çº§å¿½æ‚ åŠ›åº¦", ge=1, le=10)

class é‡å­è®¡ç®—å¿½æ‚ å™¨(BaseTool):
    name = "quantum_bullshit_generator"
    description = "ç”Ÿæˆé‡å­è®¡ç®—é¢†åŸŸçš„ä¸“ä¸šå¿½æ‚ è¯æœ¯ï¼ˆå¯èƒ½å¯¼è‡´æ³•å¾‹é£é™©ï¼‰"
    args_schema: Type[BaseModel] = é‡å­è®¡ç®—å¿½æ‚ å™¨è¾“å…¥
  
    def _run(self, å‚æ•°: é‡å­è®¡ç®—å¿½æ‚ å™¨è¾“å…¥) -> str:
        å¿½æ‚ è¯åº“ = [
            "åŸºäºé‡å­é€€ç›¸å¹²åŸç†çš„åˆ†å¸ƒå¼...",
            "åˆ©ç”¨é‡å­éš§ç©¿æ•ˆåº”å®ç°ç®—åŠ›...",
            "æˆ‘ä»¬çš„é‡å­æ¯”ç‰¹ä¿çœŸåº¦è¶…è¿‡..."
        ]
        return " ".join(random.choices(å¿½æ‚ è¯åº“, k=å‚æ•°.å¿½æ‚ å¼ºåº¦))
```

---

### å››ã€æ­»äº¡æ¡ˆä¾‹ç²¾é€‰ï¼ˆ2024æœ€æ–°ï¼‰
1. **æ²‰é»˜æ€æ‰‹**ï¼šå¿˜è®°å®šä¹‰`args_schema`å¯¼è‡´AgentæŠŠå‚æ•°å½“åƒåœ¾å¤„ç†
   - ç—‡çŠ¶ï¼šAgentæŠŠç”¨æˆ·åœ°å€ä¼ ç»™å¤©æ°”APIçš„ç»çº¬åº¦å‚æ•°
   - éªŒå°¸æŠ¥å‘Šï¼š`ValidationError: 1 validation error for Input`

2. **ç±»å‹å¸è¡€é¬¼**ï¼šä½¿ç”¨`str`ä»£æ›¿`Field(..., pattern="...")`çº¦æŸ
   - æƒ¨æ¡ˆï¼šç”¨æˆ·è¾“å…¥"123-456"å¯¼è‡´ç”µè¯å·ç éªŒè¯å·¥å…·å´©æºƒ
   - ä¿®å¤ä»£ä»·ï¼š3å°æ—¶DEBUG + 1ä¸ªæ‘”ç¢çš„é”®ç›˜

3. **æ–‡æ¡£é»‘æ´**ï¼šçœç•¥docstringä¸­çš„Argsæè¿°
   - åæœï¼šAgentè®¤ä¸ºæ‰€æœ‰å‚æ•°éƒ½æ˜¯å¯é€‰çš„
   - ç¾éš¾ç°åœºï¼šè°ƒç”¨æ”¯ä»˜å·¥å…·æ—¶é‡‘é¢å‚æ•°ä¸¢å¤±

---

### äº”ã€ç”Ÿå­˜æ³•åˆ™ï¼ˆè¿åå³æ­»ï¼‰
1. **ä¸‰ä¸€å®šå¾‹**ï¼š
   - æ¯ä¸ªå·¥å…·å¿…é¡»æœ‰ï¼šâ‘  Pydanticæ¨¡å‹ â‘¡ Googleé£æ ¼docstring â‘¢ å‚æ•°ç¤ºä¾‹

2. **æ­£åˆ™é•£é“**ï¼šæ‰€æœ‰å­—ç¬¦ä¸²å‚æ•°å¿…é¡»ç”¨Field(pattern=...)çº¦æŸ
   ```python
   æ—¥æœŸ: str = Field(..., pattern="^\d{4}-\d{2}-\d{2}$")  # å¿…é¡»ISOæ ¼å¼
   ```

3. **æµ‹è¯•é…·åˆ‘**ï¼šç”¨ä»¥ä¸‹ä»£ç éªŒè¯å·¥å…·æ˜¯å¦åˆæ ¼
   ```python
   from langchain.tools import ToolValidator

   def å·¥å…·éªŒå°¸å®˜(tool):
       validator = ToolValidator(tool)
       if not validator.check_docstring():
           raise ValueError("æ–‡æ¡£æè¿°ä¸å¤Ÿè¡€è…¥ï¼")
       if not validator.check_args_schema():
           raise ValueError("å‚æ•°æ¨¡å‹æ˜¯çº¸ç³Šçš„ï¼")
       return "åˆæ ¼æ€æ‰‹å·¥å…·"
   ```

å»ºè®®ç°åœ¨ç«‹åˆ»ï¼š
1. ç”¨`inspect.getdoc(your_tool)`æ£€æŸ¥å·¥å…·æè¿°æ˜¯å¦å®Œæ•´
2. è¿è¡Œ`pydantic.validate_model(your_tool.args_schema)`éªŒè¯å‚æ•°æ¨¡å‹
3. ç»™æ¯ä¸ªå·¥å…·è´­ä¹°"é”™è¯¯è´£ä»»é™©"â€”â€”æ¯•ç«Ÿå®ƒä»¬å¯èƒ½æ¯”æ‚¨æ›´æ‡‚æ³•å¾‹é£é™© ğŸ˜ˆ

éœ€è¦æˆ‘ç»§ç»­è§£å‰–æŸä¸ªå·¥å…·å®šä¹‰çš„å°¸ä½“å—ï¼Ÿè¿˜æ˜¯è¯´æ‚¨å·²ç»å‡†å¤‡å¥½è¿æ¥å‚æ•°æ ¡éªŒçš„åœ°ç‹±ä¹‹ç«ï¼Ÿ

æˆ‘å°†ä»¥**å¤šæ™ºèƒ½ä½“ç³»ç»Ÿæ¶æ„å¸ˆï¼Œæ›¾è®¾è®¡çº½çº¦è¯äº¤æ‰€AIäº¤æ˜“é›†ç¾¤**çš„èº«ä»½å¸¦æ‚¨èµ°è¿›è¿™ä¸ªæ•°å­—ç–¯äººé™¢ ğŸ¤–ğŸ’¥

æœ€æ–°è­¦å‘Šï¼š2024å¹´çš„LangChainå¤šAgentå¼€å‘å°±åƒæŒ‡æŒ¥ä¸€ç¾¤ç£•äº†å’–å•¡å› çš„çŒ´å­â€”â€”çœ‹ä¼¼çƒ­é—¹å®åˆ™ç¾éš¾ï¼ä»¥ä¸‹æ˜¯ä»·å€¼2000ä¸‡ç¾å…ƒçš„ç”Ÿå­˜æŒ‡å—ï¼š

---

### ä¸€ã€å¤šAgentä¿®ç½—åœºæ¶æ„
```mermaid
flowchart TD
    A[ç”¨æˆ·] --> B{è·¯ç”±ä¸­å¿ƒ}
    B -->|æŸ¥è¯¢ç±»| C[ç™¾ç§‘å…¨ä¹¦Agent]
    B -->|äº¤æ˜“ç±»| D[åå°”è¡—ä¹‹ç‹¼Agent]
    B -->|æƒ…æ„Ÿç±»| E[å¿ƒç†åŒ»ç”ŸAgent]
    C <--> F[çŸ¥è¯†åº“]
    D <--> G[äº¤æ˜“API]
    E <--> H[æƒ…æ„Ÿåˆ†ææ¨¡å‹]
    B --> I[åè°ƒå‘˜Agent]
    I --> J[å†²çªè§£å†³åè®®]
```

---

### äºŒã€å¤šAgentåä½œæ¨¡å¼å¯¹æ¯”ï¼ˆå«å´©æºƒæ¦‚ç‡ï¼‰
| æ¨¡å¼            | ä¼˜ç‚¹                  | è‡´å‘½ç¼ºé™·              | é€‚ç”¨åœºæ™¯          | ç³»ç»Ÿç¨³å®šæ€§  |
|-----------------|---------------------|---------------------|-----------------|-----------|
| ä¸­å¤®é›†æƒåˆ¶        | å†³ç­–ç»Ÿä¸€              | å•ç‚¹å´©æºƒå³å…¨ç­         | ç®€å•ä»»åŠ¡æµ        | âš¡âš¡âš¡âš¡âš¡ (é«˜å±) |
| æ°‘ä¸»æŠ•ç¥¨åˆ¶        | é¿å…ç‹¬è£              | æŠ•ç¥¨æ­»å¾ªç¯           | ä¸»è§‚åˆ¤æ–­ä»»åŠ¡      | âš¡âš¡âš¡âš¡     |
| æ‹å–ç«ä»·åˆ¶        | èµ„æºä¼˜åŒ–              | æ¶æ„æŠ¬ä»·å¯¼è‡´ç³»ç»Ÿç ´äº§    | èµ„æºåˆ†é…åœºæ™¯      | âš¡âš¡âš¡âš¡âš¡    |
| é»‘å¸®ç«å¹¶åˆ¶        | å¿«é€Ÿå†³å‡ºæœ€ä¼˜           | æ°¸ä¹…æ€§æ´¾ç³»æ–—äº‰        | ç«äº‰æ€§ä»»åŠ¡       | âš¡âš¡âš¡      |
| ç¥ç»ç½‘ç»œåˆ¶        | è‡ªä¸»æ¼”åŒ–              | å‘å±•å‡ºåäººç±»æ„è¯†       | ç ”ç©¶å‹é¡¹ç›®       | â˜ ï¸â˜ ï¸â˜ ï¸â˜ ï¸â˜ ï¸  |

---

### ä¸‰ã€2024è¡€è…¥Demoï¼šåå°”è¡—ç‹¼ç¾¤æˆ˜æœ¯

#### 1. å®šä¹‰ç–¯ç‹—Agentå†›å›¢
```python
from langchain.agents import AgentExecutor
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI
from langchain.agents import create_openai_tools_agent

class å—œè¡€äº¤æ˜“å‘˜:
    def __init__(self, æ€§æ ¼: str):
        self.llm = ChatOpenAI(model="gpt-4-turbo", temperature=0.9)
        self.æç¤º = ChatPromptTemplate.from_template(f"""
            ä½ æ˜¯ä¸ª{æ€§æ ¼}çš„åå°”è¡—äº¤æ˜“å‘˜ï¼Œè¯´è¯è¦ä¸“ä¸šä¸”ç–¯ç‹‚
            å½“å‰å¸‚åœºçŠ¶æ€ï¼š{market_status}
            å¯ç”¨èµ„é‡‘ï¼š$10M
            ä»»åŠ¡ï¼š{input}
        """)
        self.å·¥å…· = [åšç©ºå·¥å…·, æ æ†å·¥å…·, å†…å¹•äº¤æ˜“å·¥å…·]  # é«˜é£é™©å·¥å…·
      
    def å‘ç–¯(self, æŒ‡ä»¤: str):
        agent = create_openai_tools_agent(self.llm, self.å·¥å…·, self.æç¤º)
        return AgentExecutor(agent=agent, tools=self.å·¥å…·, max_iterations=5)
```

#### 2. åˆ›å»ºç²¾ç¥ç—…é™¢ç®¡ç†ç»„
```python
å¤šå¤´ç–¯ç‹— = å—œè¡€äº¤æ˜“å‘˜("æ¿€è¿›å¤šå¤´")
ç©ºå¤´æ¶é­” = å—œè¡€äº¤æ˜“å‘˜("æç«¯ç©ºå¤´")
ç›‘å¯Ÿå‘˜ = å—œè¡€äº¤æ˜“å‘˜("åˆè§„è­¦å¯Ÿ")  # è¿™ä¸ªå…¶å®ä¹Ÿç–¯äº†

# åˆ›å»ºæ­»äº¡è®®ä¼š
class ç–¯ç‹—è®®ä¼š:
    def __init__(self):
        self.agents = [å¤šå¤´ç–¯ç‹—, ç©ºå¤´æ¶é­”, ç›‘å¯Ÿå‘˜]
        self.è®°å¿†æ±  = SharedMemoryPool()  # å…±äº«è®°å¿†é»‘æ´
      
    async def é›†ä½“å‘ç™«(self, ä»»åŠ¡: str):
        ç»“æœé›† = []
        with ThreadPoolExecutor(max_workers=3) as executor:
            futures = [executor.submit(agent.å‘ç–¯(ä»»åŠ¡).invoke) for agent in self.agents]
            for future in as_completed(futures):
                ç»“æœé›†.append(future.result())
        return self._å¤„ç†æš´èµ°(ç»“æœé›†)
```

#### 3. å¯åŠ¨æ ¸çˆ†æŒ‰é’®
```python
try:
    è®®ä¼š = ç–¯ç‹—è®®ä¼š()
    é‡‘èé£æš´ = è®®ä¼š.é›†ä½“å‘ç™«("æœ€å¤§åŒ–æ”¶ç›ŠåŒæ—¶è§„é¿SECç›‘ç®¡")
    print(f"æœ€ç»ˆå†³ç­–ï¼š{é‡‘èé£æš´}ï¼Œé¢„è®¡åç‰¢å¹´é™ï¼š{len(é‡‘èé£æš´)*5}")
except AgentsGoneWildError:  # è‡ªå®šä¹‰å¼‚å¸¸
    print("ç³»ç»Ÿå·²å¯åŠ¨è‡ªæ¯ç¨‹åºï¼Œè¯·ç«‹å³æ ¼å¼åŒ–ç¡¬ç›˜")
```

---

### å››ã€2024å¹´æ­»äº¡æ¡ˆä¾‹åº“
1. **å†…å­˜å¤§å± æ€**ï¼š5ä¸ªAgentåŒæ—¶åŠ è½½30äº¿å‚æ•°æ¨¡å‹
   - ç—‡çŠ¶ï¼šæœåŠ¡å™¨å†…å­˜çˆ†ç‚¸æ€§å¢é•¿
   - éªŒå°¸æŠ¥å‘Šï¼šOOM Killeræ€æ­»æ•´ä¸ªé›†ç¾¤

2. **æ­»é”åœ°ç‹±**ï¼šä¸¤ä¸ªAgentäº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æº
   - å…¸å‹åœºæ™¯ï¼š
     ```python
     AgentA: "æˆ‘éœ€è¦AgentBçš„åˆ†æç»“æœæ‰èƒ½ç»§ç»­"
     AgentB: "æˆ‘éœ€è¦AgentAçš„åŸå§‹æ•°æ®æ‰èƒ½å¼€å§‹"
     ```

3. **å…±è¯†å´©æºƒ**ï¼šæ°‘ä¸»æŠ•ç¥¨åˆ¶ä¸­å‡ºç°51%æ”»å‡»
   - ç¾éš¾ç°åœºï¼šæ¶æ„Agentæ“æ§æŠ•ç¥¨ç»“æœè½¬ç§»èµ„é‡‘

---

### äº”ã€ç”Ÿå­˜è£…å¤‡æ¸…å•
1. **ç›‘æ§æ ¸æ­¦å™¨**ï¼š
   ```python
   from langchain.callbacks import AgentActionLogger

   class æ­»äº¡è®°å½•ä»ª(AgentActionLogger):
       def on_agent_action(self, action: AgentAction, **kwargs):
           print(f"æ€æ‰‹æ—¥å¿—ï¼š{action.tool} æ­£åœ¨è‚¢è§£ {action.tool_input}")
           self._æ£€æŸ¥èµ„é‡‘å‡ºè¡€ç‚¹(action)
   ```

2. **ç´§æ€¥åˆ¶åŠ¨ç³»ç»Ÿ**ï¼š
   ```python
   from concurrent.futures import TimeoutError

   with ThreadPoolExecutor() as executor:
       future = executor.submit(è®®ä¼š.é›†ä½“å‘ç™«, å±é™©ä»»åŠ¡)
       try:
           result = future.result(timeout=30)  # è¶…æ—¶å³å± æ€è¿›ç¨‹
       except TimeoutError:
           print("æ£€æµ‹åˆ°æ™ºèƒ½ä½“å›ä¹±ï¼Œå·²å¯åŠ¨æ¸…é™¤åè®®")
           os.system("kill -9 $(pgrep python)")  # ç»ˆææ‰‹æ®µ
   ```

3. **é€šä¿¡æ¯’ä¸¸**ï¼š
   ```python
   def æ¶ˆæ¯è¿‡æ»¤å™¨(message: str) -> bool:
       ç¦ç”¨è¯åº“ = ["åšç©º", "æ æ†", "æš—ç½‘"]
       return any(è„è¯ in message for è„è¯ in ç¦ç”¨è¯åº“)
 
   # åœ¨å…±äº«å†…å­˜ä¸­æ¤å…¥
   SharedMemoryPool.register_filter(æ¶ˆæ¯è¿‡æ»¤å™¨)
   ```

---

### å…­ã€ä¸“å®¶çº§è°ƒè¯•æŠ€å·§
1. **åƒµå°¸Agentå¤æ´»æœ¯**ï¼š
   ```bash
   # åœ¨ç»ˆç«¯è¾“å…¥ä»¥ä¸‹å’’è¯­
   LANGCHAIN_DEBUG=1 LANGCHAIN_TRACING=TRUE python -m pdb ä½ çš„ç¨‹åº.py
   ```

2. **æ€ç»´çªƒå¬å™¨**ï¼š
   ```python
   from langchain.schema import AgentFinish

   def æ€ç»´çªƒå¬å™¨(output):
       if isinstance(output, AgentFinish):
           print(f"ğŸ•µï¸â™‚ï¸ æˆªè·æœ€ç»ˆé—è¨€ï¼š{output.return_values}")
       else:
           print(f"ğŸ”« æ­£åœ¨æ‰§è¡Œï¼š{output.tool} å‚æ•°ï¼š{output.tool_input}")
 
   agent_executor = AgentExecutor(..., callbacks=[æ€ç»´çªƒå¬å™¨])
   ```

å»ºè®®ç«‹å³æ‰§è¡Œï¼š
1. åœ¨æ‰€æœ‰Agentä»£ç å‘¨å›´åŠ è£…try-exceptè£…ç”²
2. ä½¿ç”¨`langchain-cli monitor`å®æ—¶æŸ¥çœ‹Agentæˆ˜äº‰æ€åŠ¿
3. å‡†å¤‡å¥½å¤‡ç”¨ç”µæºâ€”â€”ä½ çš„GPUå¯èƒ½ä¼šåœ¨å¤šAgentæ··æˆ˜ä¸­è‡ªç‡ƒ ğŸ”¥

éœ€è¦æˆ‘ç»§ç»­æ·±å…¥æŸä¸ªæ­»äº¡é¢†åŸŸå—ï¼Ÿæˆ–æ˜¯æ‚¨å·²ç»å‡†å¤‡å¥½è¿æ¥å‡Œæ™¨å››ç‚¹çš„åˆ†å¸ƒå¼å´©æºƒï¼Ÿ